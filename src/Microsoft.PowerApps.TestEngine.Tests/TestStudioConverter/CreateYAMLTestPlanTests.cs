// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.

using Microsoft.PowerApps.TestEngine.Config;
using Microsoft.PowerApps.TestEngine.TestStudioConverter;
using Moq;
using System;
using System.Collections.Generic;
using System.IO;
using Microsoft.Extensions.Logging;
using Xunit;
using Microsoft.PowerApps.TestEngine.System;
using YamlDotNet;
using YamlDotNet.Core;
using YamlDotNet.Serialization;
using YamlDotNet.Serialization.NamingConventions;

namespace Microsoft.PowerApps.TestEngine.Tests.TestStudioConverter
{
    public class CreateYAMLTestPlanTests
    {
        [Fact]
        public void ValidFileTest()
        {
            var InputDir = "path/to/nothing/that/exists/test.json";
            ILoggerFactory loggerFactory = LoggerFactory.Create(builder => { builder.ClearProviders(); builder.AddConsole(); });
            ILogger<CreateYAMLTestPlan> logger = loggerFactory.CreateLogger<CreateYAMLTestPlan>();
            CreateYAMLTestPlan converter = new CreateYAMLTestPlan(logger, InputDir);

            Assert.Throws<DirectoryNotFoundException>(
                () => converter.exportYAML()
            );
        }

        [Fact]
        public void CheckTestStepsAndYamlTest()
        {
            var testJson = @"{
    ""TopParent"": {
        ""Type"": ""ControlInfo"",
        ""Name"": ""Test_7F478737223C4B69"",
        ""Template"": {
            ""Id"": ""http://microsoft.com/appmagic/apptest"",
            ""Version"": ""1.0"",
            ""LastModifiedTimestamp"": ""0"",
            ""Name"": ""AppTest"",
            ""FirstParty"": true,
            ""IsPremiumPcfControl"": false,
            ""IsCustomGroupControlTemplate"": false,
            ""CustomGroupControlTemplateName"": """",
            ""IsComponentDefinition"": false,
            ""OverridableProperties"": {}
        },
        ""Index"": 0.0,
        ""PublishOrderIndex"": 0,
        ""VariantName"": """",
        ""LayoutName"": """",
        ""MetaDataIDKey"": """",
        ""PersistMetaDataIDKey"": false,
        ""IsFromScreenLayout"": false,
        ""StyleName"": """",
        ""Parent"": """",
        ""IsDataControl"": true,
        ""AllowAccessToGlobals"": true,
        ""IsGroupControl"": false,
        ""IsAutoGenerated"": false,
        ""Rules"": [],
        ""ControlPropertyState"": [],
        ""IsLocked"": false,
        ""ControlUniqueId"": ""2"",
        ""Children"": [
            {
                ""Type"": ""ControlInfo"",
                ""Name"": ""a2788d19-22e2-4a03-b8ba-3ebc4aad96b5"",
                ""HasDynamicProperties"": false,
                ""Template"": {
                    ""Id"": ""http://microsoft.com/appmagic/testsuite"",
                    ""Version"": ""1.0"",
                    ""LastModifiedTimestamp"": ""0"",
                    ""Name"": ""TestSuite"",
                    ""FirstParty"": true,
                    ""IsPremiumPcfControl"": false,
                    ""IsCustomGroupControlTemplate"": false,
                    ""CustomGroupControlTemplateName"": """",
                    ""IsComponentDefinition"": false,
                    ""OverridableProperties"": {}
                },
                ""Index"": 0.0,
                ""PublishOrderIndex"": 0,
                ""VariantName"": """",
                ""LayoutName"": """",
                ""MetaDataIDKey"": """",
                ""PersistMetaDataIDKey"": false,
                ""IsFromScreenLayout"": false,
                ""StyleName"": """",
                ""Parent"": ""Test_7F478737223C4B69"",
                ""IsDataControl"": true,
                ""AllowAccessToGlobals"": true,
                ""IsGroupControl"": false,
                ""IsAutoGenerated"": false,
                ""Rules"": [
                    {
                        ""Property"": ""DisplayName"",
                        ""Category"": ""Data"",
                        ""InvariantScript"": ""\""Suite\"""",
                        ""RuleProviderType"": ""Unknown""
                    },
                    {
                        ""Property"": ""Description"",
                        ""Category"": ""Data"",
                        ""InvariantScript"": ""\""\"""",
                        ""RuleProviderType"": ""Unknown""
                    }
                ],
                ""ControlPropertyState"": [
                    ""DisplayName"",
                    ""Description""
                ],
                ""IsLocked"": false,
                ""ControlUniqueId"": ""5"",
                ""Children"": [
                    {
                        ""Type"": ""ControlInfo"",
                        ""Name"": ""e8b0a102-2096-4cfc-a6a4-c4b4030ec8c9"",
                        ""HasDynamicProperties"": false,
                        ""Template"": {
                            ""Id"": ""http://microsoft.com/appmagic/testcase"",
                            ""Version"": ""1.0"",
                            ""LastModifiedTimestamp"": ""0"",
                            ""Name"": ""TestCase"",
                            ""FirstParty"": true,
                            ""IsPremiumPcfControl"": false,
                            ""IsCustomGroupControlTemplate"": false,
                            ""CustomGroupControlTemplateName"": """",
                            ""IsComponentDefinition"": false,
                            ""OverridableProperties"": {}
                        },
                        ""Index"": 0.0,
                        ""PublishOrderIndex"": 0,
                        ""VariantName"": """",
                        ""LayoutName"": """",
                        ""MetaDataIDKey"": """",
                        ""PersistMetaDataIDKey"": false,
                        ""IsFromScreenLayout"": false,
                        ""StyleName"": """",
                        ""Parent"": ""a2788d19-22e2-4a03-b8ba-3ebc4aad96b5"",
                        ""IsDataControl"": true,
                        ""AllowAccessToGlobals"": true,
                        ""IsGroupControl"": false,
                        ""IsAutoGenerated"": false,
                        ""Rules"": [
                            {
                                ""Property"": ""DisplayName"",
                                ""Category"": ""Data"",
                                ""InvariantScript"": ""\""Case\"""",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""Description"",
                                ""Category"": ""Data"",
                                ""InvariantScript"": ""\""Missing Test Description\"""",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""TestStepsMetadata"",
                                ""Category"": ""Data"",
                                ""InvariantScript"": ""\""[{\""\""Description\""\"":\""\""SetProperty(IncrementControl1, 10)\""\"",\""\""Rule\""\"":\""\""Step1\""\"",\""\""ScreenId\""\"":null},{\""\""Description\""\"":\""\""Assert(In)\""\"",\""\""Rule\""\"":\""\""Step2\""\"",\""\""ScreenId\""\"":null},{\""\""Description\""\"":\""\""SetProperty(IncrementControl1.value, 20)\""\"",\""\""Rule\""\"":\""\""Step3\""\"",\""\""ScreenId\""\"":null},{\""\""Description\""\"":\""\""Assert(IncrementControl1.value = 20, \\\""\""Make sure increment control is set to 10\\\""\"")\""\"",\""\""Rule\""\"":\""\""Step4\""\"",\""\""ScreenId\""\"":null}]\"""",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""Step1"",
                                ""Category"": ""Behavior"",
                                ""InvariantScript"": ""SetProperty(IncrementControl1.value, 10)"",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""Step2"",
                                ""Category"": ""Behavior"",
                                ""InvariantScript"": ""Assert(IncrementControl1.value = 10, \""Make sure increment control is set to 10\"")"",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""Step3"",
                                ""Category"": ""Behavior"",
                                ""InvariantScript"": ""SetProperty(IncrementControl1.value, 20)"",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""Step4"",
                                ""Category"": ""Behavior"",
                                ""InvariantScript"": ""Assert(IncrementControl1.value = 20, \""Make sure increment control is set to 10\"")"",
                                ""RuleProviderType"": ""Unknown""
                            }
                        ],
                        ""ControlPropertyState"": [
                            ""DisplayName"",
                            ""Description"",
                            ""Step1"",
                            ""TestStepsMetadata"",
                            ""Step2"",
                            ""Step3"",
                            ""Step4""
                        ],
                        ""IsLocked"": false,
                        ""ControlUniqueId"": ""6"",
                        ""Children"": []
                    }
                ]
            }
        ]
    }
}";

            var expectedYamlTestPlan = @"testSuite:
  testSuiteName: Suite
  testSuiteDescription: 
  persona: User1
  appLogicalName: Replace with appLogicalName
  networkRequestMocks: 
  testCases:
    - testCaseName: Case
      testCaseDescription: Missing Test Description
      testSteps: |
        = 
        SetProperty(IncrementControl1,""value"", 10);
        Assert(IncrementControl1.value = 10, ""Make sure increment control is set to 10"");
        SetProperty(IncrementControl1,""value"", 20);
        Assert(IncrementControl1.value = 20, ""Make sure increment control is set to 10"");
testSettings:
  browserConfigurations:
  - browser: Chromium
    device: 
    screenWidth: 
    screenHeight: 
  recordVideo: true
  enablePowerFxOverlay: false
  timeout: 30000
environmentVariables:
  users:
  - personaName: User1
    emailKey: user1Email
    passwordKey: user1Password";

            ILoggerFactory loggerFactory = LoggerFactory.Create(builder => { builder.ClearProviders(); builder.AddConsole(); });
            ILogger<CreateYAMLTestPlan> logger = loggerFactory.CreateLogger<CreateYAMLTestPlan>();

            var mockFileIO = new Mock<IFileSystem>(MockBehavior.Strict);

            var jsonFilePath = "test.json";
            mockFileIO.Setup(f => f.ReadAllText(It.IsAny<string>())).Returns(testJson);
            mockFileIO.Setup(f => f.IsValidFilePath(It.IsAny<string>())).Returns((bool)true);
            mockFileIO.Setup(f => f.WriteTextToFile(It.IsAny<string>(), It.IsAny<string>()));
            CreateYAMLTestPlan converter = new CreateYAMLTestPlan(logger, jsonFilePath, mockFileIO.Object);
            
            converter.exportYAML();

            List<TestCase> actualTestCases = converter.GetTestCases();
            TestPlanDefinition? actualTestPlan = converter.GetYamlTestPlan();

            Assert.Equal("Case", actualTestCases[0].TestCaseName);
            Assert.Equal("Missing Test Description", actualTestCases[0].TestCaseDescription);

            var deserializer = new DeserializerBuilder()
            .WithNamingConvention(CamelCaseNamingConvention.Instance)
            .Build();

            var expectedTestObject = deserializer.Deserialize<TestPlanDefinition>(expectedYamlTestPlan);
            Assert.Equal(expectedTestObject.ToString(), actualTestPlan?.ToString());

        }

        [Fact]
        public void EmptyTestStepsTest()
        {
            var testJsonWithoutSteps = @"{
    ""TopParent"": {
        ""Type"": ""ControlInfo"",
        ""Name"": ""Test_7F478737223C4B69"",
        ""Template"": {
            ""Id"": ""http://microsoft.com/appmagic/apptest"",
            ""Version"": ""1.0"",
            ""LastModifiedTimestamp"": ""0"",
            ""Name"": ""AppTest"",
            ""FirstParty"": true,
            ""IsPremiumPcfControl"": false,
            ""IsCustomGroupControlTemplate"": false,
            ""CustomGroupControlTemplateName"": """",
            ""IsComponentDefinition"": false,
            ""OverridableProperties"": {}
        },
        ""Index"": 0.0,
        ""PublishOrderIndex"": 0,
        ""VariantName"": """",
        ""LayoutName"": """",
        ""MetaDataIDKey"": """",
        ""PersistMetaDataIDKey"": false,
        ""IsFromScreenLayout"": false,
        ""StyleName"": """",
        ""Parent"": """",
        ""IsDataControl"": true,
        ""AllowAccessToGlobals"": true,
        ""IsGroupControl"": false,
        ""IsAutoGenerated"": false,
        ""Rules"": [],
        ""ControlPropertyState"": [],
        ""IsLocked"": false,
        ""ControlUniqueId"": ""2"",
        ""Children"": [
            {
                ""Type"": ""ControlInfo"",
                ""Name"": ""a2788d19-22e2-4a03-b8ba-3ebc4aad96b5"",
                ""HasDynamicProperties"": false,
                ""Template"": {
                    ""Id"": ""http://microsoft.com/appmagic/testsuite"",
                    ""Version"": ""1.0"",
                    ""LastModifiedTimestamp"": ""0"",
                    ""Name"": ""TestSuite"",
                    ""FirstParty"": true,
                    ""IsPremiumPcfControl"": false,
                    ""IsCustomGroupControlTemplate"": false,
                    ""CustomGroupControlTemplateName"": """",
                    ""IsComponentDefinition"": false,
                    ""OverridableProperties"": {}
                },
                ""Index"": 0.0,
                ""PublishOrderIndex"": 0,
                ""VariantName"": """",
                ""LayoutName"": """",
                ""MetaDataIDKey"": """",
                ""PersistMetaDataIDKey"": false,
                ""IsFromScreenLayout"": false,
                ""StyleName"": """",
                ""Parent"": ""Test_7F478737223C4B69"",
                ""IsDataControl"": true,
                ""AllowAccessToGlobals"": true,
                ""IsGroupControl"": false,
                ""IsAutoGenerated"": false,
                ""Rules"": [
                    {
                        ""Property"": ""DisplayName"",
                        ""Category"": ""Data"",
                        ""InvariantScript"": ""\""Suite\"""",
                        ""RuleProviderType"": ""Unknown""
                    },
                    {
                        ""Property"": ""Description"",
                        ""Category"": ""Data"",
                        ""InvariantScript"": ""\""\"""",
                        ""RuleProviderType"": ""Unknown""
                    }
                ],
                ""ControlPropertyState"": [
                    ""DisplayName"",
                    ""Description""
                ],
                ""IsLocked"": false,
                ""ControlUniqueId"": ""5"",
                ""Children"": [
                    {
                        ""Type"": ""ControlInfo"",
                        ""Name"": ""e8b0a102-2096-4cfc-a6a4-c4b4030ec8c9"",
                        ""HasDynamicProperties"": false,
                        ""Template"": {
                            ""Id"": ""http://microsoft.com/appmagic/testcase"",
                            ""Version"": ""1.0"",
                            ""LastModifiedTimestamp"": ""0"",
                            ""Name"": ""TestCase"",
                            ""FirstParty"": true,
                            ""IsPremiumPcfControl"": false,
                            ""IsCustomGroupControlTemplate"": false,
                            ""CustomGroupControlTemplateName"": """",
                            ""IsComponentDefinition"": false,
                            ""OverridableProperties"": {}
                        },
                        ""Index"": 0.0,
                        ""PublishOrderIndex"": 0,
                        ""VariantName"": """",
                        ""LayoutName"": """",
                        ""MetaDataIDKey"": """",
                        ""PersistMetaDataIDKey"": false,
                        ""IsFromScreenLayout"": false,
                        ""StyleName"": """",
                        ""Parent"": ""a2788d19-22e2-4a03-b8ba-3ebc4aad96b5"",
                        ""IsDataControl"": true,
                        ""AllowAccessToGlobals"": true,
                        ""IsGroupControl"": false,
                        ""IsAutoGenerated"": false,
                        ""Rules"": [
                            {
                                ""Property"": ""DisplayName"",
                                ""Category"": ""Data"",
                                ""InvariantScript"": ""\""Case\"""",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""Description"",
                                ""Category"": ""Data"",
                                ""InvariantScript"": ""\""\"""",
                                ""RuleProviderType"": ""Unknown""
                            },
                            {
                                ""Property"": ""TestStepsMetadata"",
                                ""Category"": ""Data"",
                                ""InvariantScript"": ""\""[{\""\""Description\""\"":\""\""SetProperty(IncrementControl1, 10)\""\"",\""\""Rule\""\"":\""\""Step1\""\"",\""\""ScreenId\""\"":null},{\""\""Description\""\"":\""\""Assert(In)\""\"",\""\""Rule\""\"":\""\""Step2\""\"",\""\""ScreenId\""\"":null},{\""\""Description\""\"":\""\""SetProperty(IncrementControl1.value, 20)\""\"",\""\""Rule\""\"":\""\""Step3\""\"",\""\""ScreenId\""\"":null},{\""\""Description\""\"":\""\""Assert(IncrementControl1.value = 20, \\\""\""Make sure increment control is set to 10\\\""\"")\""\"",\""\""Rule\""\"":\""\""Step4\""\"",\""\""ScreenId\""\"":null}]\"""",
                                ""RuleProviderType"": ""Unknown""
                            }
                        ],
                        ""ControlPropertyState"": [
                            ""DisplayName"",
                            ""Description"",
                            ""Step1"",
                            ""TestStepsMetadata"",
                            ""Step2"",
                            ""Step3"",
                            ""Step4""
                        ],
                        ""IsLocked"": false,
                        ""ControlUniqueId"": ""6"",
                        ""Children"": []
                    }
                ]
            }
        ]
    }
}";

            ILoggerFactory loggerFactory = LoggerFactory.Create(builder => { builder.ClearProviders(); builder.AddConsole(); });
            ILogger<CreateYAMLTestPlan> logger = loggerFactory.CreateLogger<CreateYAMLTestPlan>();


            var mockFileIO = new Mock<IFileSystem>(MockBehavior.Strict);
            
            mockFileIO.Reset();

            var jsonFilePath = "test.json";
            mockFileIO.Setup(f => f.ReadAllText(It.IsAny<string>())).Returns(testJsonWithoutSteps);
            mockFileIO.Setup(f => f.IsValidFilePath(It.IsAny<string>())).Returns((bool)true);
            mockFileIO.Setup(f => f.WriteTextToFile(It.IsAny<string>(), It.IsAny<string>()));
            CreateYAMLTestPlan emptyConverter = new CreateYAMLTestPlan(logger, jsonFilePath, mockFileIO.Object);

            emptyConverter.exportYAML();

            List<TestCase> emptyTestCases = emptyConverter.GetTestCases();
            Assert.Empty(emptyTestCases[0].TestSteps);
        }
    }
}


